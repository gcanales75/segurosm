(function(a,b){'use strict';function c(l){l.get('$mundialPayments')}function e(l,m){return{restrict:'E',scope:{munTransactionId:'='},link:function(o,q,r){if(void 0==o.munTransactionId){o.styleError={color:'red',fontSize:'18px',fontWeight:'bolder'};return void $('#voucherPayment').html('<div class="text-center" ng-style="styleError">Ha Ocurrido un error, por favor comuniquese con el administrador</div>')}o.imgLoading=l.imgLoading,o.isLoading=l.isLoading,l.imgLoading&&(o.style={width:'100%',height:'100%',position:'absolute',backgroundColor:'rgba(0,0,0,0.2)',backgroundImage:'url('+l.imgLoading+')',backgroundSize:'auto 90%',backgroundRepeat:'no-repeat',backgroundPositionX:'center',zIndex:'2'}),l.init().then(function(){var t=m(function(){l.executed&&(m.cancel(t),l.authObject.success&&(l.executed=!1,l.getConfirmPayment(o.munTransactionId).then(function(){var u=m(function(){if(l.executed&&(m.cancel(u),l.isGetConfirmPayment)){if($('#voucherPayment').html(l.voucherPayment),void 0!=r.mainClass){var v=r.mainClass.split(' ');$.each(v,function(w,z){$('#mainVoucherContainer').addClass(z)})}if(void 0!=r.classHeader){var v=r.classHeader.split(' ');$.each(v,function(w,z){$('#headerVoucher').addClass(z)})}if(void 0!=r.classSubTitle){var v=r.classSubTitle.split(' ');$.each(v,function(w,z){$('.subTitleVoucher').each(function(){$(this).addClass(z)})})}if(void 0!=r.classPreText){var v=r.classPreText.split(' ');$.each(v,function(w,z){$('.preTextVoucher').each(function(){$(this).addClass(z)})})}if(void 0!=r.classTitles){var v=r.classTitles.split(' ');$.each(v,function(w,z){$('.titlesVoucher').each(function(){$(this).addClass(z)})})}if(void 0!=r.classData){var v=r.classData.split(' ');$.each(v,function(w,z){$('.dataVoucher').each(function(){$(this).addClass(z)})})}o.isLoading=!1}},500)})))},500)})},template:'<div class="row" style="min-height: 100px; position: relative;"><div ng-show="isLoading" ng-style="style"></div><div class="col-md-12" id="voucherPayment"></div></div>'}}function f(l,m){var n='';return void 0==l.UserId&&(n+='No se ha definido el id de usaurio, por favor definalo.'),void 0==l.Currency&&(n+='\nNo se ha definido el la moneda de la transacci\xF3n, por favor definala.'),void 0==l.Description&&(n+='\nLa descripcion es obligatoria.'),void 0==l.TotalAmmount?n+='\nEl valor total de la transaccion es obligatorio.':0>=l.TotalAmmount&&(n+='\nEl valor total de la transaccion debe ser > 0.'),void 0==l.Tax?n+='\nEl valor del Iva es obligatorio, si no lo conoce, definalo en 0.':void 0!=l.TaxReturnBase&&0<l.TaxReturnBase&&0>=l.Tax&&(n+='\nEl valor del Iva no puede ser inferior o igual 0 cuando existe una base de calculo.'),void 0==l.TaxReturnBase?n+='\nLa base de calculo para el iva es obligatorio, si no lo conoce dejelo en 0.':void 0!=l.Tax&&0<l.Tax&&0>=l.TaxReturnBase&&(n+='\nLa base de calculo para el iva no puede ser menor o igual a 0 cuando el iva es diferente de 0.'),void 0==l.PurchaseId&&(n+='\nEl No. de referencia de la compra es obligatorio.'),void 0==l.BuyerEmail&&(n+='\nEl Email del comprador es obligatorio.'),void 0==l.UrlResponse&&(n+='\nDebe definir una url de respuesta, es obligatoria.'),m&&void 0==l.urlConfirmation&&(n+='\nEl metodo de pago escogido, requiere una url de confirmaci\xF3n de pago.'),n}function g(l,m,n){return{restrict:'E',scope:{ngModel:'=',ngForm:'='},link:function(o,q,r){return o.imgLoading=l.imgLoading,o.isLoading=l.isLoading,l.imgLoading&&(o.style={width:'100%',height:'100%',position:'absolute',backgroundColor:'rgba(0,0,0,0.2)',backgroundImage:'url('+l.imgLoading+')',backgroundSize:'auto 90%',backgroundRepeat:'no-repeat',backgroundPositionX:'center',zIndex:'2'}),l.init().then(function(){var s=m(function(){return l.executed&&(m.cancel(s),l.authObject.success?(l.executed=!1,l.getPaymentMethods().then(function(){var u=m(function(){if(l.executed)if(m.cancel(u),l.isGetPaymentMethodParams){o.paymentMethodList=l.paymentMethodList,$.each(o.paymentMethodList,function(z,A){A.MaxImageHeight='100px',A.MaxImageWidth=Math.round(100*A.widthImage/A.heightImage)+'px'});var v=0;if(void 0==r.rowView)o.rowView=!1;else if(o.rowView='true'===r.rowView,o.rowView){var w=l.paymentMethodList.length;v=Math.floor(12/w),1>v&&(v=1)}o.styles={'col-md-1':1===v,'col-md-2':2===v,'col-md-3':3===v,'col-md-4':4===v,'col-md-5':5===v,'col-md-6':6===v,'col-md-7':7===v,'col-md-8':8===v,'col-md-9':9===v,'col-md-10':10===v,'col-md-11':11===v,'col-md-12':12===v,'col-sm-1':1===v,'col-sm-2':2===v,'col-sm-3':3===v,'col-sm-4':4===v,'col-sm-5':5===v,'col-sm-6':6===v,'col-sm-7':7===v,'col-sm-8':8===v,'col-sm-9':9===v,'col-sm-10':10===v,'col-sm-11':11===v,'col-sm-12':12===v,'col-xs-1':1===v,'col-xs-2':2===v,'col-xs-3':3===v,'col-xs-4':4===v,'col-xs-5':5===v,'col-xs-6':6===v,'col-xs-7':7===v,'col-xs-8':8===v,'col-xs-9':9===v,'col-xs-10':10===v,'col-xs-11':11===v,'col-xs-12':12===v},o.sendDataError=!1,o.processPayment=function(z){if(o.isLoading=!0,void 0==o.ngModel)return o.messageError='Ha ocurrido un error al enviar el pago, por favor comuniquelo al administrador del sistema',console.log('No se ha definido ningun modelo para procesar'),o.sendDataError=!0,void(o.isLoading=!1);var A=null;$.each(o.paymentMethodList,function(E,F){F.idPaymentMethod==z&&(A=F)}),o.ngModel.TypePaymentMethod=A.typePaymentMethod,o.ngModel.PaymentMethod=A.paymentMethod;var B=f(o.ngModel,A.requireUrlConfirmation);if(0<B.length)return o.messageError='Ha ocurrido un error al enviar el pago, por favor comuniquelo al administrador del sistema',console.log(B),o.sendDataError=!0,void(o.isLoading=!1);n.defaults.headers.common.Authorization=l.authObject.token_type+' '+l.authObject.appToken;var C=l.remoteServiceHost+'/api/pms/ProcessPayment',D=JSON.stringify(o.ngModel);n({url:C,method:'POST',data:D}).then(function(E){E.data.success?void 0==r.ngForm?($('#loadFormRedirect').html(E.data.data),$('#enviarPago').click()):($('#'+r.ngForm).prop('method','POST'),$('#'+r.ngForm).prop('action',E.data.url),$('#'+r.ngForm).append(E.data.dataSend),$('#'+r.ngForm).submit()):(o.sendDataError=!0,o.messageError='Ha ocurrido un error al enviar el pago, por favor intentelo mas tarde',o.isLoading=!1,console.log(E.data.Message))},function(E){o.sendDataError=!0,o.messageError='Ha ocurrido un error al enviar el pago, por favor intentelo mas tarde',o.isLoading=!1,console.log(E.Message)})},o.shPse=l.shPse,o.shTc=l.shTc,o.tcImg=l.tcImg,o.pseImg=l.pseImg,o.mundialServiceError=l.executed&&!l.isGetPaymentMethodParams&&!l.authObject.success,o.isLoading&&(o.isLoading=!1)}else o.mundialServiceError=!0,o.isLoading&&(o.isLoading=!1);return!1},500);return!1})):(o.mundialServiceError=!0,o.isLoading&&(o.isLoading=!1))),!1},500);return!1}),!1},template:'<div style="position: relative; min-height:50px;"><div id="loadFormRedirect" ></div><div ng-show="isLoading" ng-style="style"></div><div ng-show="!mundialServiceError"><div class="row"><div ng-repeat="paymentMethod in paymentMethodList"><div class="text-center" ng-class="styles"><button style="background-color: rgba(0,0,0,0); border:0px;" ng-click="processPayment(paymentMethod.idPaymentMethod)" onclick="return false;"><img class="col-md-12 col-sm-12 col-xs-12" src="{{paymentMethod.byteImage}}" /></button></div></div></div></div><div ng-show="sendDataError"><div style="color:red; font-weight:bolder; font-size:18px;">{{messageError}}</div></div><div ng-show="mundialServiceError"><div style="color:red; font-weight:bolder; font-size:18px;">Ha ocurrido un error, por favor intentelo mas tarde o comuniquese con el administrador</div></div></div>'}}function h(l,m){return{required:['form','nameButton','munTransactionId'],restrict:'E',scope:{munTransactionId:'='},link:function(o,q,r){return l.init().then(function(){var s=m(function(){if(l.executed)if(m.cancel(s),l.authObject.success){if(l.executed=!1,void 0==r.form)return void l.alert('Debe incluir el formulario');if(void 0==r.nameButton)return void l.alert('Debe incluir el nombre del boton');if(o.textButton=r.nameButton,void 0==o.munTransactionId)return void l.alert('Debe incluir el id de Transaccion');if(void 0!=r.classButton){var t=r.classButton.split(' ');$.each(t,function(u,v){$('#reqConfirmPaymentButton').addClass(v)})}o.requestProcess=function(){l.getDataConfirm(o.munTransactionId).then(function(){var u=m(function(){if(!l.executed);else if(m.cancel(u),l.isGetDataConfirmPayment){var v=[];v.push('<input type="hidden" id="idRecaudo" name="idRecaudo" value="'+l.paymentConfirmResponse.idRecaudo+'" />'),v.push('<input type="hidden" id="transactionState" name="transactionState" value="'+l.paymentConfirmResponse.transactionState+'" />'),v.push('<input type="hidden" id="message" name="message" value="'+l.paymentConfirmResponse.message+'" />'),v.push('<input type="hidden" id="reference_sale" name="reference_sale" value="'+l.paymentConfirmResponse.reference_sale+'" />'),v.push('<input type="hidden" id="reference_pol" name="reference_pol" value="'+l.paymentConfirmResponse.reference_pol+'" />'),v.push('<input type="hidden" id="payment_method_name" name="payment_method_name" value="'+l.paymentConfirmResponse.payment_method_name+'" />'),v.push('<input type="hidden" id="date" name="date" value="'+l.paymentConfirmResponse.date+'" />'),v.push('<input type="hidden" id="pse_bank" name="pse_bank" value="'+l.paymentConfirmResponse.pse_bank+'" />'),v.push('<input type="hidden" id="bank_id" name="bank_id" value="'+l.paymentConfirmResponse.bank_id+'" />'),v.push('<input type="hidden" id="cod_pse" name="cod_pse" value="'+l.paymentConfirmResponse.cod_pse+'" />'),v.push('<input type="hidden" id="codRespuesta" name="codRespuesta" value="'+l.paymentConfirmResponse.codRespuesta+'" />'),$.each(v,function(w,z){$('#'+r.form).append(z)}),$('#'+r.form).submit()}else;return!1},500);return!1})}}else;return!1},500);return!1}),!1},template:'<a ng-click="requestProcess()" id="reqConfirmPaymentButton">{{textButton}}</a>'}}var j=b.module('ngMundialPayments',['ngCookies']).info({angularVersion:'1.7.0-rc.0'}).provider('$mundialPayments',function(){function m(){var A=n(5,10),B=[],F='';B.push([65,90]),B.push([97,122]),B.push([48,57]);for(var G,H=0;10>H;H++){do G=n(0,B.length);while(G>=B.length);var I=n(B[G][0],B[G][1]);F+=String.fromCharCode(I)}return F}function n(A,B){return Math.round(Math.random()*(B-A)+A)}var o,q,r,s,t,v,w,z;this.initMundialProvider=function(A,B,C,D){o=A,q=B,r=q+'/api/Account/CallbackExternal',s=q+'/api/Account/Auth',v=C,w=D},this.initMundialProvider=function(A,B,C,D,E){o=A,q=B,r=q+'/api/Account/CallbackExternal',s=q+'/api/Account/Auth',t=q+'/api/Account/token',v=C,w=D,z=E},this.$get=['$window','$http','$interval','$cookies',function(A,B,C,D){function E(ca=!1){ba=ca;var da={client_id:S,state:M},ea=null,fa=null,ga=null;ca&&G&&G.success?(F.authObject={},F.authObject.success=!1,ea=L,fa='POST',da.refresh_token=F.authObject.refresh_token,da.grant_type='refresh_token',ga={url:ea,method:fa,headers:{'Content-Type':'application/x-www-form-urlencoded'},transformRequest:function(ha){var ia=[];for(var ja in ha)ia.push(encodeURIComponent(ja)+'='+encodeURIComponent(ha[ja]));return console.log(ia.join('&')),ia.join('&')},data:da}):(fa='GET',ea=K,da.redirect_uri=J,da.userId=T,da.response_type='code',ga={url:ea,method:fa,params:da}),0!=Y&&(C.cancel(Y),Y=0),B(ga).then(function(ha){G={},G.appToken=ha.data.access_token,G.refresh_token=ha.data.refresh_token,G.refresh=ha.data.refresh,G.expires=ha.data.expires,G.token_type=ha.data.token_type,G.message='Token Obtenido',G.success=!0,F.authObject=G,F.executed=!0,D.putObject('pAuthObject',G),ba=!1},function(ha){-1==ha.status?5>U?Y=C(function(){U+=1,E()},2e3):(F.executed=!0,G.message='Se han superado la cantidad de reintentos',G.success=!1,F.authObject=G,U=0,D.remove('pAuthObject'),D.remove('pState'),ba=!1):(ca&&(ba=!1,E()),F.executed=!0,G.message='Error al obtener el Token: '+ha.data.Message,G.success=!1,F.authObject=G,D.remove('pAuthObject'),D.remove('pState'))})}var F={},G={},H=o,I=q,J=r,K=s,L=t,M=D.get('pState');M||(M=M?M:m(),D.put('pState',M));var S=v,T=w,U=0,V=0,W=0,X=0,Y=0,Z=0,_=0,aa=0,ba=!1;return z?(F.imgLoading=z,F.isLoading=!0):F.isLoading=!1,F.executed=!1,F.remoteServiceHost=H,F.remoteAuthHost=I,F.init=function(){return M||(M=M?M:m(),D.put('pState',M)),G=D.getObject('pAuthObject'),G?(F.authObject=G,F.executed=!0):E(),this},(F.then=function(ca){return ca(),this},F.getConfirmPayment=function(ca){B.defaults.headers.common.Authorization=F.authObject.token_type+' '+F.authObject.appToken;var da=JSON.stringify(ca);return 0!=_&&(C.cancel(_),_=0),B({url:H+'/api/pms/GetConfirmPayment',method:'POST',data:da}).then(function(ea){ea.data.success?(F.voucherPayment=ea.data.voucherPayment,F.executed=!0,F.isGetConfirmPayment=!0):(F.executed=!0,F.isGetConfirmPayment=!1,F.errorMessage=ea.data.message)},function(ea){-1!=ea.status&&401!=ea.status?(F.executed=!0,F.isGetConfirmPayment=!1,F.errorMessage=ea.data.Message):(401==ea.status&&!ba&&E(!0),5>V?_=C(function(){V+=1,F.getPaymentMethods()},2e3):(F.executed=!0,F.isGetConfirmPayment=!1,F.errorMessage='Se han superado la cantidad de reintentos',V=0))}),this},F.getDataConfirm=function(ca){return B.defaults.headers.common.Authorization=F.authObject.token_type+' '+F.authObject.appToken,0!=aa&&(C.cancel(aa),aa=0),B({url:H+'/api/pms/GetDataConfirm',method:'POST',data:JSON.stringify(ca)}).then(function(da){da.data.success?(F.paymentConfirmResponse=da.data.paymentConfirmResponse,F.executed=!0,F.isGetDataConfirmPayment=!0):(F.executed=!0,F.isGetDataConfirmPayment=!1,F.errorMessage=da.data.message)},function(da){-1!=da.status&&401!=da.status?(F.executed=!0,F.isGetDataConfirmPayment=!1,F.errorMessage=da.data.Message):(401==da.status&&!ba&&E(!0),5>W?aa=C(function(){W+=1,F.getPaymentMethods()},2e3):(F.executed=!0,F.isGetDataConfirmPayment=!1,F.errorMessage='Se han superado la cantidad de reintentos',W=0))}),this},F.getPaymentMethods=function(){return B.defaults.headers.common.Authorization=F.authObject.token_type+' '+F.authObject.appToken,0!=Z&&(C.cancel(Z),Z=0),B.post(H+'/api/pms/PaymentMethodsParams').then(function(ca){ca.data.success?(F.paymentMethodList=ca.data.paymentMethodList,F.executed=!0,F.isGetPaymentMethodParams=!0):(F.executed=!0,F.isGetPaymentMethodParams=!1,F.errorMessage=ca.data.message)},function(ca){if(-1!=ca.status&&401!=ca.status)F.executed=!0,F.isGetPaymentMethodParams=!1,F.errorMessage=ca.data.Message;else if(401!=ca.status)5>X?Z=C(function(){X+=1,F.getPaymentMethods()},2e3):(F.executed=!0,G.message='Se han superado la cantidad de reintentos',G.success=!1,F.authObject=G,X=0);else if(!ba){E(!0);var da=C(function(){F.authObject.success&&(C.cancel(da),F.getPaymentMethods())},1e3)}}),this},F.alert=function(ca){A.alert(ca)},F)}]}).directive('ngMunButtons',g).directive('ngMunVoucherConfirm',e).directive('ngMunConfirmPayment',h).run(c),k=b.$$minErr('ngMundialPayments');c.$inject=['$injector'],e.$inject=['$mundialPayments','$interval','$http'],g.$inject=['$mundialPayments','$interval','$http'],h.$inject=['$mundialPayments','$interval','$http']})(window,window.angular);